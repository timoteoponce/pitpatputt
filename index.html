<html>

<head>
    <title>Pit Put Patt</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./simple.min.css">
    <script>
        const alphabet = [
            { "0": "pit.mp3" },
            { "1": "put.mp3" },
            { "2": "part.mp3" },
            { "3": "pet.mp3" },
            { "4": "port.mp3" },
            { "5": "pert.mp3" },
            { "6": "putt.mp3" },
            { "7": "peat.mp3" },
            { "8": "pot.mp3" },
            { "9": "pat.mp3" },
        ];
        let audio = undefined;
        let audioIndex = 0;
        let telephoneNumber = undefined;

        function initTelephoneNumber() {
            return Object.keys(alphabet) // only the keys from 'alphabet' => 0, 1, 
                .sort(() => .5 - Math.random()) // randomize it
                .slice(0, 7); // take only 7
        }

        function toggle(selector, enabled) {
            document.querySelectorAll(selector).forEach(d => d.disabled = !enabled);
        }

        function stopAudio() {
            if (audio) {
                audio.pause();
                audioIndex = 0;
                toggle('#play-btn', true); //re-enable play button
            }
        }

        function playAudio() {
            stopAudio();
            if (!telephoneNumber) {
                telephoneNumber = initTelephoneNumber();
                toggle('#reset-btn', true);
                toggle('.number-inputs input', true);
            }
            let playlist = telephoneNumber.map(k => alphabet.find(t => t[k])[k]);
            console.debug('Current telephone number is', alphabet, telephoneNumber, playlist);
            audio = new Audio();
            // add an event listener to continue the playlist
            audio.addEventListener('ended', function () {
                audioIndex = ++audioIndex < playlist.length ? audioIndex : -1;
                if (audioIndex === -1) {
                    stopAudio();
                } else {
                    setTimeout(() => {
                        if (audio) {
                            audio.src = playlist[audioIndex];
                            console.debug('playing', playlist[audioIndex])
                            audio.play();
                        }
                    }, 250); // using a timeout to delay the sound a bit
                }
            }, true);
            toggle('#play-btn', false); //disable play button
            audio.src = playlist[0];
            audio.play();
        }

        function checkNumber() {
            let base = telephoneNumber.map(d => Number(d));
            let inputNumbers = Array.from(document.querySelectorAll('.number-inputs input')) // select all 'input' children from element with ''.number-inputs' class
                .map(i => i.value)
                .map(d => Number(d)); // convert it to number
            console.log('inputNumbers', inputNumbers);
            if (JSON.stringify(base) === JSON.stringify(inputNumbers)) {
                alert('Congratulations!! You\'ve made it')
            } else {
                alert('Numbers don\'t match the telephone number')
            }
        }

        function reset() {
            stopAudio();
            telephoneNumber = undefined;
            audio = undefined;
            toggle('#start-btn', true);
            toggle('#reset-btn', false);
            toggle('.number-inputs input', false);
        }

        function play(key) {
            let item = alphabet.find(t => t[key]);
            if (item) {
                let itemAudio = new Audio(item[key]);
                itemAudio.play();
            }
        }
    </script>
    <style>
        .number-inputs {
            display: inline;
        }

        input {
            width: 4rem;
        }

        .play-icon {
            background-color: transparent;
            border: none;
            display: inline-block;
        }

        .play-icon:hover{
            opacity: .8;
        }

        .play-icon img {
            height: 0.9rem;
        }
    </style>
</head>

<body>
    <h1>Pit Pat Putt</h1>
    <blockquote>
        A game based on <a href="https://africa.teachingenglish.org.uk/classroom/pronunciation/telephone-numbers"
            target="_blank"> the telephone numbers game</a>
    </blockquote>

    <aside>
        <fieldset>
            <legend>Glossary:</legend>
            <ul id="word-list">
                <li>pit: 0 <button class="play-icon" onclick="play('0')"><img src="volume.png"></button></li>
                <li>put: 1 <button class="play-icon" onclick="play('1')"><img src="volume.png"></button></li>
                <li>part: 2 <button class="play-icon" onclick="play('2')"><img src="volume.png"></button></li>
                <li>pet: 3 <button class="play-icon" onclick="play('3')"><img src="volume.png"></button></li>
                <li>port: 4 <button class="play-icon" onclick="play('4')"><img src="volume.png"></button></li>
                <li>pert: 5 <button class="play-icon" onclick="play('5')"><img src="volume.png"></button></li>
                <li>putt: 6 <button class="play-icon" onclick="play('6')"><img src="volume.png"></button></li>
                <li>peat: 7 <button class="play-icon" onclick="play('7')"><img src="volume.png"></button></li>
                <li>pot: 8 <button class="play-icon" onclick="play('8')"><img src="volume.png"></button></li>
                <li>pat: 9 <button class="play-icon" onclick="play('9')"><img src="volume.png"></button></li>
            </ul>
        </fieldset>
    </aside>
    <main>
        <fieldset>
            <legend>Game</legend>
            <button onclick="playAudio()" id="play-btn">Play numbers!</button>
            <button disabled onclick="reset()" id="reset-btn">Reset game</button>

            <div>
                <h3>Telephone number</h3>
                <p>Write the digits corresponding to the numbers you've heard</p>
                <form id="numbers-form" onsubmit="return false;">
                    <div class="number-inputs">
                        <input type="number" required="true" disabled>
                        <input type="number" required="true" disabled>
                        <input type="number" required="true" disabled>
                        <input type="number" required="true" disabled>
                        <input type="number" required="true" disabled>
                        <input type="number" required="true" disabled>
                        <input type="number" required="true" disabled>
                    </div>
                    <button onclick="checkNumber()">Check!</button>
                </form>
            </div>
        </fieldset>
    </main>
</body>

</html>